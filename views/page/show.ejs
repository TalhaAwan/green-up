<!DOCTYPE html>
<html lang="en">

<?include ../partials/head ?>

<body>



 <? include ../partials/header ?>



 <!-- Page Content -->
 <div class="container">
   <div  class="row">
     <div class="col-md-2">
     </div>
     <div class="col-md-8">
      <!-- Page Heading -->
      <div class="row">
        <div class="col-lg-12">
          <h1 class="page-header">
            <?= page.title ?>
          </h1>

        </div>
      </div>
      <!-- /.row -->


      <div class="row">
        <div class="col-lg-12 text-left">
          <div class="row ">

            <div  class="col-md-12">
              <?- page.statement ?>
            </div>
          </div>
        </div>
      </div>
      <!-- /.row -->

      <div class="row">
        <hr>
        <div class="col-lg-12">
         <div id="page-comments">
           <? include ./component/page/comment  ?>
         </div>
         <br>

         <? if (comments && comments.length) {?>
         <a href="javascript:" id="load-more-<?= page.id ?>" style="font-size: 0.875em" onclick="loadMoreComments('<?=page._id?>')">load more comments</a> <br><br>
         <? } ?>

         <form id="page-comment<?=page._id?>" name="page-comment" >
           
            <div class="row form-group">
              <div class="col-sm-6">
                <input class="form-control" type="text" name="name" placeholder="Name" required>
              </div>
            </div>
            <div class="row form-group ">
              <div class="col-sm-6">
                <input class="form-control" type="text" name="essential" placeholder="Essential">
              </div>
            </div>
            <div class="row form-group">
             <div class="col-sm-12">
              <textarea class="form-control" id="text" rows="7" name="text" placeholder="Comment" required></textarea>
            </div>
          </div>
          <div class="row form-group">
           <div class="col-sm-12">
             <input  id="rtl" type="checkbox" name="rtl" value="true"> Allign right to left<br> 
           </div>
         </div>

       <button  id="add-comment-btn" type="button" class="btn btn-primary" onclick="addComment('<?=page._id?>')" >Add
       </button>
     </form>

   </div>
 </div>

</div>
<!-- /.container -->

</div>
</div>
</div>
<!-- /#wrapper -->
<? include ../partials/footer ?>


<script>

  var commentId;
  $(document).ready(function(){
    commentId = $("#page-comments .page").last().attr('data-id');
  })

  function loadMoreComments(id) { 
    var query = "/"+id+"/comments?";
    $.get(query + "commentId=" + commentId, function(data, status){
      if(!data){
        $( "#load-more-"+id ).hide();
        triggerCommentInterval(id);
      }
      else{
        commentId = $(data).last().attr('data-id')
        $( "#page-comments").append(data);
        $('[id]').each(function () {
          $('[id="' + this.id + '"]:gt(0)').remove();
        });
        $("#page-comments .page").sort(function (a, b) {
          var contentA = Date.parse( $(a).attr('data-date'));
          var contentB = Date.parse( $(b).attr('data-date'));
          return (contentA < contentB) ? -1 : (contentA > contentB) ? 1 : 0;
        }).appendTo("#page-comments")
      }

    });

  }


  function triggerCommentInterval(id){
    setInterval(function(){
      var query = "/"+id+"/comments?";
      $.get(query + "commentId=" + commentId, function(data, status){
        if(data){
          $( "#page-comments" ).append(data);
          $('[id]').each(function () {
            $('[id="' + this.id + '"]:gt(0)').remove();
          });
          $("#page-comments .page").sort(function (a, b) {
            var contentA = Date.parse( $(a).attr('data-date'));
            var contentB = Date.parse( $(b).attr('data-date'));
            return (contentA < contentB) ? -1 : (contentA > contentB) ? 1 : 0;
          }).appendTo("#page-comments")
        }
      });
    }, 30000);

  }



  function addComment (id){
    var data = {};
    $("#page-comment"+ id).serializeArray().map(function(x){data[x.name] = x.value;}); 
    if(!data.text){
      $("#text").after("<div id='text-validation-error' style='color:red;'>Please enter comment</div>");
      $( "#text" ).focus(function() {
        $("#text-validation-error").remove();
        $(this).off('focus');
      });
    }
    else{
      data.rtl? data.rtl = JSON.parse(data.rtl): null;
      $('#add-comment-btn').attr('disabled', 'disabled'); 
      $.ajax({
       url: "/"+ id +"/comments",
       data: data,
       type: 'POST',
       success: function(data) {
        $("#page-comments" ).append( data );
        $("#page-comment"+ id + " textarea[name=text]").val('');
        $('#add-comment-btn').removeAttr('disabled'); 
      },

      error: function(error){
        console.log(error)
      }
    });
    }
  };

  $('#rtl').change(function() {
    $("#text").css('direction',  this.checked? 'rtl' : 'ltr');                
  });


</script>

</body>

</html>


